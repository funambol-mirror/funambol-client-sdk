<?xml version="1.0" encoding="iso-8859-1" ?>

<!--
================================================================================
Build file for Funambol J2ME Mail Client.
================================================================================
-->
<project name="Funambol J2ME Common" default="rapc" basedir="..">
    <!-- Define the tasks. -->
    <taskdef resource="antenna.properties"/>    

    <target name="init">
        <property file="build/build_${platform}.properties"/>
        <property file="build/build.properties"/>
        <property file="build/signature.properties"/>
        <property file="build/properties/${manufacturer}/${family}/${device}/${device}.properties"/>
        <property file="build/properties/${manufacturer}/${family}/${family}.properties"/>
        <property file="build/properties/${manufacturer}/${manufacturer}.properties"/>
        <property file="build/properties/default.properties"/>

        <property name="jad.filename.suffix"  value=""/>
        <property name="jad.filename"         value="MailTest"/>
        <property name="jar.filename"         value="${jad.filename}"/>

        <property name="bb.simulator.path" value="${bb.jdehome}/simulator" />
        <property name="bb.sigtool" value="${bb.jdehome}/bin/SignatureTool.jar"/>

    </target>
    
    <!-- =============================================== -->
    <!-- Launch JDWP - Blackberry Debug tool             -->
    <!-- =============================================== -->
    <target name="debugbb" depends="init" if="bb.jdwp.path">
        <exec executable="${bb.jdwp.path}/jdwp.bat" spawn="true" dir="${bb.jdwp.path}"/>
    </target>

    <!-- This is a compound target which "builds" all the necessary resource
         for the blackberry -->
    <target name="build_bb" depends="init, rapc, bbalx, bbsimulatorinstall" />
    
    <!-- =============================================== -->
    <!-- BUILD RAPC - Native blackberry compiler         -->
    <!-- SET bb.rapc in build.properties to run during   -->
    <!-- a build.                                        -->
    <!-- =============================================== -->
    <!--
      Note that not all versions of rapc correctly import resources (icons) when running against a jar.
      Also, the rapc .jad file does not contain entries for sibling .cod files. This is fine for the simulator
      but OTA installations require that each sibling cod file have an entry in the .jad.
      RAPC can also only process signed midlets. 
    -->
    <target name="rapc" description="RIM COD Compiler" depends="init">

        <!-- Blackberry RAPC parameters -->
        <property name="dir.build"             value="${basedir}/build"/>
        <property name="bb.buildjars.home"     location="${bb.jdehome}/bin"/>
        <property name="bb.api.jar"            location="${bb.jdehome}/lib/net_rim_api.jar"/>

        <echo>dir.build: ${dir.build}</echo>
        <echo>bb.buildjars.home: ${bb.buildjars.home}</echo>
        <echo>bb.api.jar: ${bb.api.jar}</echo>
        <echo>dir.output.native: ${dir.output.native}</echo>
        <!-- WTKRAPC seems to only execute RAPC in the working directory -->
    
        <!-- Copy off the originally generated .jad file because rapc will alter
             it with BB specific params -->
        <copy file="${dir.output}/${jad.filename}.jad" tofile="${dir.output}/${jad.filename}.jad2"/>
    
        <!-- we need to use the executable instead of wtkrapc because wtkrapc
             strips the RIM-MIDLet-Flags attribute-->
    
        <exec executable="${bb.jdehome}/bin/rapc.exe" spawn="false">
            <arg value="import=${bb.api.jar}"/>
            <arg value="codename=${jad.filename}"/>
            <arg value="-midlet"/>
            <arg value="jad=${dir.output}/${jad.filename}.jad2"/>
            <arg value="${dir.output}/${jar.filename}.jar"/>
        </exec>
    
        <move todir="${dir.output}">
            <fileset dir="${basedir}">
                <include name="${jad.filename}*.cod"/>
                <include name="${jad.filename}*.cso"/>
                <include name="${jad.filename}*.csl"/>
                <include name="${jad.filename}*.debug"/>
                <include name="${jad.filename}*.ja?"/>
            </fileset>
        </move>
    
        <copy file="${dir.output}/${jad.filename}.jad2" tofile="${dir.output}/${jad.filename}.jad"/>
        <delete file="${dir.output}/${jad.filename}.jad2"/>
    
        <!-- Sign the midlet with RIM SignatureTool. RIM ceritifcates must
             be copied into the directory containing the SignaturTool.jar -->
        <!-- The password argument allows the build process to be completely
             automatic, but it requires a JDE version >= 4.3 -->
        <!--
        <exec executable="java" spawn="false">
            <arg value="-jar"/>
            <arg value="${bb.sigtool}"/>
            <arg value="-a"/>
            <arg value="-C"/>
            <arg value="${dir.output}/${jad.filename}.cod"/>
        </exec>

        <move file="${dir.output}/${jad.filename}.cod"
              tofile="${dir.output}/${jad.filename}.zip"/>
        <unzip dest="${dir.output}" src="${dir.output}/${jad.filename}.zip">
        </unzip>
        -->
        <delete file="${dir.build}/${jad.filename}.jar"/>
    </target>

    <target name="bbalx">
        <echo file="${dir.output}/${jad.filename}.alx">
&lt;loader version="1.0"&gt;
&lt;application id="${app.name}"&gt;
&lt;name&gt;
${app.name}
&lt;/name&gt;
&lt;description&gt;${app.name}&lt;/description&gt;
&lt;version&gt;${pkg.version}&lt;/version&gt;
&lt;vendor&gt;Funambol&lt;/vendor&gt;
&lt;fileset Java="1.0"&gt;
&lt;files&gt;${jad.filename}.cod&lt;/files&gt;
&lt;files&gt;${jad.filename}-1.cod&lt;/files&gt;
&lt;files&gt;${jad.filename}-2.cod&lt;/files&gt;
&lt;files&gt;${jad.filename}-3.cod&lt;/files&gt;
&lt;/fileset&gt;
&lt;/application&gt;
&lt;/loader&gt;
        </echo>
    </target>
    
    <!-- =============================================== -->
    <!-- Blackberry Simulator Install                    -->
    <!-- =============================================== -->
    <target name="bbsimulatorinstall" depends="init">
        <!-- Copy to simulator directory. If this fails, do not fail the script since it may not be defined. -->
        <copy file="${dir.output}/${jad.filename}.cod" tofile="${bb.simulator.path}/${jad.filename}.cod" failonerror="false"/>
        <copy todir="${bb.simulator.path}" failonerror="false">
            <fileset dir="${dir.output}">
                <include name="${jad.filename}*.debug"/>
            </fileset>
        </copy>
    </target>
</project>

<?xml version="1.0" encoding="iso-8859-1" ?>

<!--
================================================================================
Build file for Funambol J2ME Mail Client.
================================================================================
-->
<project name="Funambol J2ME Common" default="build" basedir="..">
    <!-- Define the tasks. -->
    <taskdef resource="antenna.properties"/>
    <!--
    ========================================================================
     Setting variable
    ========================================================================
    -->
    <target name="init">
        <tstamp>
            <format property="timestamp.MM" pattern="MM" />
            <format property="timestamp.dd" pattern="dd" />
            <format property="timestamp.HH" pattern="HH" />
        </tstamp>

        <property name="platform" value="j2me"/>

        <property name="dir.src.push"     value="${basedir}/src/com/funambol/push" />
        <property name="dir.src.storage"  value="${basedir}/src/com/funambol/storage" />
        <property name="dir.src.tools"    value="${basedir}/src/com/funambol/tools" />
        <property name="dir.src.updater"  value="${basedir}/src/com/funambol/updater" />
        <property name="dir.src.util"     value="${basedir}/src/com/funambol/util" />
        <property name="dir.src.pim"      value="${basedir}/src/com/funambol/common/pim" />

        <property name="dir.src"
                  value="${dir.src.push};${dir.src.storage};${dir.src.tools};${dir.src.updater};${dir.src.util}"
        />

        <property name="dir.pdsrc"        value="${basedir}/pdsrc/${platform}"/>
        <property name="dir.test"         value="${basedir}/test/src"            />
        <property name="dir.test.jme"         value="${basedir}/test/pdsrc/jme"            />
        <property name="dir.test.bb"         value="${basedir}/test/pdsrc/blackberry"            />
        <property name="dir.res"          value="${basedir}/res"             />     
        <property name="dir.output"       value="${basedir}/output"          />    
        <property name="dir.preproc.src"  value="${dir.output}/preproc_src"  />
        <property name="dir.docs"         value="${basedir}/docs"            />      
        <property name="dir.output.html"  value="${dir.output}/html"         />
        <!-- WTK Definitions -->
        <property name="wtk.home"                value="C://tools//WTK2.5.1" />
        <property name="wtk.cldc.version"        value="1.0"      />
        <property name="wtk.midp.version"        value="2.0"      />
        <property name="wtk.midp_api"            value="${wtk.home}/lib/midpapi20.jar"/>
        <property name="wtk.optionalpda.enabled" value="true"     />
        <property name="wtk.debug"               value="false"                      />
    
        <!-- External dependencies -->
        <property name="lib.junit"        value="${basedir}/lib/JMUnit4CLDC10.jar"/>
        <property name="lib.gzip"         value="${basedir}/lib/tinyline-gzip.jar"/>
        <property name="wma.jar"          value="${wtk.home}/lib/wma11.jar"/>
        <property name="bb.api.jar"     location="${bb.jdehome}/lib/net_rim_api.jar"/>
	<property name="dir.pim-parsers"      value="externals/pim-parsers"/>
    	


        <!-- Standard SDK runtime environment parameters -->
        <property name="emu.device"           value="DefaultColorPhone"/>
        <property name="emu.heapsize"         value="700K"/>
        <property name="emu.wait"             value="true"/>
        <property name="j2me.version"         value="${j2me.release.major}.${j2me.release.minor}.${j2me.build.number}"/>

        <!-- WTK Definitions -->
        <property name="wtk.cldc.version"        value="1.0"/>
        <property name="wtk.midp.version"        value="2.0"/>
        <property name="wtk.optionalpda.enabled" value="false"/>
        <property name="wtk.wma.enabled"         value="true"/>
        <property name="wtk.debug"               value="false"/>
        <property name="wma.jar"                 value="${wtk.home}/lib/wma11.jar"/>
        <property name="mmapi.jar"               value="${wtk.home}/lib/mmapi.jar"/>
        <property name="libs.extra" value="" />
        <property name="classpath" value="${wma.jar};${mmapi.jar};${libs.extra}"/>

	</target>

    <!-- =================================================================== -->
    <!-- generate_parsers                                                    -->
    <!-- ====================================================================-->
    <!-- Compile sources -->
    <target name="generate_parsers" depends="init">
        <echo message="Importing parsers"/>
   
        <mkdir dir="${dir.src.pim}/vcard/generated"/>

        <delete>
            <fileset dir="${dir.src.pim}/vcard/generated">
                <include name="FieldsList.java"/>
                <include name="ParamList.java"/>
                <include name="SimpleCharStream.java"/>
                <include name="Token.java"/>
                <include name="TokenMgrError.java"/>
                <include name="VcardSyntaxParserConstants.java"/>
                <include name="VCardSyntaxParser.java"/>
                <include name="VcardSyntaxParserListener.java"/>
                <include name="VCardSyntaxParserTokenManager.java"/>
            </fileset>
        </delete>

	<javacc target="${dir.pim-parsers}/src/main/javacc/VCardSyntaxParser.jj"
                outputdirectory="${dir.src.pim}/vcard/generated"
                javacchome="${javacchome}" />
    
        <copy todir="${dir.src.pim}/vcard/generated">
		<fileset dir="${dir.pim-parsers}/src/main/java/com/funambol/common/pim">
                <include name="*.java"/>
            </fileset>
        </copy>

        <copy todir="${dir.src.pim}/vcard/generated">
		<fileset dir="${dir.pim-parsers}/src/main/java/com/funambol/common/pim/vcard">
                <include name="*.java"/>
            </fileset>
        </copy>

        <antcall target="postprocessjj"/>

        <copy todir="${dir.preproc.src}">
            <fileset dir="${dir.src.pim}/vcard/generated">
                <include name="*.java"/>
            </fileset>
        </copy>

        <delete file="${dir.preproc.src}/ParseException.java"/>
            
        <copy todir="${dir.preproc.src}">
            <fileset dir="${dir.src.pim}/vcard">
                <include name="*.java"/>
            </fileset>
        </copy>

        <copy todir="${dir.preproc.src}">
            <fileset dir="${dir.src.pim}">
                <include name="*.java"/>
            </fileset>
        </copy>

    </target>

    <target name="postprocessjj" depends="init">
        <echo message="Postprocessing JavaCC generated files" />
        <taskdef name="postprocessjj" classname="javaccpostprocessor.JavaccPostProcessor"
                 classpath="${basedir}/build/JavaccPostProcessor.jar" />

        <postprocessjj jjsrcfile="${dir.src.pim}/vcard/generated/VCardSyntaxParser.java">
        </postprocessjj>

        <move   file   = "${dir.src.pim}/vcard/generated/VCardSyntaxParser.java.pp"
                tofile = "${dir.src.pim}/vcard/generated/VCardSyntaxParser.java" />

    </target>


    <!-- =================================================================== -->
    <!-- COMPILE                                                             -->
    <!-- Compile the files                                                   -->
    <!-- ====================================================================-->
    <!-- Compile sources -->
    <target name="compile_single" depends="preprocess, generate_parsers">
        <mkdir dir="${dir.classes}"/>
        <wtkbuild srcdir="${dir.preproc.src}" destdir="${dir.classes}"
              target="1.1" source="1.2" preverify="false" debug="${wtk.debug}"
              listfiles="yes" >
            <classpath>
                <pathelement location="${lib.gzip}"/>
                <pathelement location="${wma.jar}"/>
                <pathelement location="${libs.extra}"/>
            </classpath>
        </wtkbuild>
    </target>
    
    <target name="preprocess" depends="init">
        
        <mkdir dir="${dir.preproc.src}"/>
        
        <echo message="Platform: ${platform}"/>
        
        <property name="isBlackberry" value="isBlackberry"/>
        
        <condition property="symbols" value="${isBlackberry}" else="j2me">
            <equals arg1="${platform}" arg2="blackberry"/>
        </condition>
        
        <echo message="preproc value: ${symbols}"/>
        
        <!--The condition over "symbol" is to avoid the empty parameter case-->
        <wtkpreprocess srcdir="${dir.src.push}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>

        <wtkpreprocess srcdir="${dir.src.tools}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>

        <wtkpreprocess srcdir="${dir.src.storage}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>

        <wtkpreprocess srcdir="${dir.src.updater}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>

        <wtkpreprocess srcdir="${dir.src.util}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>

        <wtkpreprocess srcdir="${dir.pdsrc}"
                       destdir="${dir.preproc.src}"
                       symbols="${symbols}"
                       verbose="false" 
                       indent="false"
                       printsymbols="true">
        </wtkpreprocess>
 
        
        
    </target>

    <!-- Compile test classes for jme devices-->
    <target name="compile_test" depends="compile_single">
        <wtkbuild srcdir="${dir.test};${dir.test.jme}" destdir="${dir.classes}"
              target="1.1" source="1.2" preverify="false" debug="${wtk.debug}">
            <classpath>
                <pathelement location="${lib.junit}"/>
                <pathelement location="${lib.gzip}"/>
                <pathelement location="${wma.jar}"/>
                <pathelement location="${libs.extra}"/>
            </classpath>
            
        </wtkbuild>
    </target>
    
    <!-- Compile test classes for jme devices-->
    <target name="compile_test_bb" depends="compile_single">
        <wtkbuild srcdir="${dir.test};${dir.test.bb}" destdir="${dir.classes}"
              target="1.1" source="1.2" preverify="false" debug="${wtk.debug}">
            <classpath>
                <pathelement location="${lib.junit}"/>
                <pathelement location="${lib.gzip}"/>
                <pathelement location="${wma.jar}"/>
                <pathelement location="${libs.extra}"/>
            </classpath>
            
        </wtkbuild>
    </target>
    
    <!-- =================================================================== -->
    <!-- RELEASE                                                             -->
    <!-- When a new release is created, the release.properties file is       -->
    <!-- updated with the current date and incrementing the build number.    -->
    <!-- ====================================================================-->
    <target name="release_single">
        <antcall target="compile_single"/>
        <antcall target="docs"/> <!-- public javadocs for release -->
        <zip zipfile="${dir.output}/${j2me.name}-${j2me.version}.zip">
            <zipfileset dir="." includes="**/*" excludes="CVS/, **/nbproject/"/>
        </zip>
        
    </target>


    <!-- =============================================== -->
    <!-- JME TEST                                        -->
    <!-- =============================================== -->
    <target name="test_single" depends="init">
        
        <!-- Unpack the dependent packages -->
        <unjar src="${lib.junit}" dest="${dir.classes}"/>
        <unjar src="${lib.gzip}"  dest="${dir.classes}"/>
        <copy todir="${dir.classes}/res">
            <fileset dir="${dir.res}" includes="*.properties" />
        </copy>
        <!-- Create a JAD file. -->
        <property name="pack" value="com.funambol"/>

        <!-- These permissions are needed for VCardParser test -->
        <property name="jad.MIDlet-Permissions"
                  value="javax.microedition.pim.ContactList.read,javax.microedition.pim.ContactList.write"/>
        
        <wtkjad jadfile="${dir.output}/CommonTest.jad"
            jarfile="${dir.output}/CommonTest.jar"
            name="CommonTest"
            vendor="Funambol Inc."
            version="${j2me.version}">

            <attribute name="MIDlet-Permissions" value="${jad.MIDlet-Permissions}"/>

            <attribute name="J2MEUnitTestClasses"
            value="${pack}.updater.UpdaterTest,${pack}.util.StringUtilTest,${pack}.util.ThreadPoolTest,${pack}.storage.ObjectStoreTest,${pack}.storage.NamedObjectStoreTest,${pack}.storage.NamedObjectStorePerfTest,${pack}.util.MD5Test,${pack}.util.MailDateFormatterTest,${pack}.util.StringUtilTest,${pack}.util.RMS_LogDisabledTest,${pack}.util.RMSAppenderTest,${pack}.util.XmlUtilTest,${pack}.util.HttpTransportAgent,${pack}.common.pim.vcard.VCardParserTest,${pack}.util.ConnectionManagerTest"/>
            <midlet name="CommonTest" class="com.funambol.util.FunTestRunner"/>

        </wtkjad>
        
        <!-- Package everything. Most of the necessary information is
         contained in the JAD file. Also preverify the result this
         time. To obfuscate everything, set the corresponding
         parameter to "true" (requires RetroGuard or ProGuard). The
         version parameter increments the MIDlet-Version by one. -->
        
        <wtkpackage jarfile="${dir.output}/CommonTest.jar"
            jadfile="${dir.output}/CommonTest.jad"
            obfuscate="false"
            preverify="true" classpath="${wma.jar};${libs.extra}">
            
            
            <!-- Package our newly compiled classes. -->
            <fileset dir="${dir.classes}" includes="**/*.class"/>
            <!--<fileset file="${lib.junit}"/>-->
            
            <fileset dir="${dir.classes}" includes="res/*.properties" />
            <fileset dir="${basedir}/test" includes="res/*.txt" />
            
        </wtkpackage>
        
    </target>
    
    <!-- =============================================== -->
    <!-- BB TEST                                         -->
    <!-- =============================================== -->
    <target name="test_single_bb" depends="init">
        
        <!-- Unpack the dependent packages -->
        <unjar src="${lib.junit}" dest="${dir.classes}"/>
        <unjar src="${lib.gzip}"  dest="${dir.classes}"/>
        <copy todir="${dir.classes}/res">
            <fileset dir="${dir.res}" includes="*.properties" />
        </copy>
        <!-- Create a JAD file. -->
        <property name="pack" value="com.funambol"/>

        <!-- These permissions are needed for VCardParser test -->
        <property name="jad.MIDlet-Permissions"
                  value="javax.microedition.pim.ContactList.read,javax.microedition.pim.ContactList.write"/>
        
        <wtkjad jadfile="${dir.output}/CommonTest.jad"
            jarfile="${dir.output}/CommonTest.jar"
            name="CommonTest"
            vendor="Funambol Inc."
            version="${j2me.version}">

            <attribute name="MIDlet-Permissions" value="${jad.MIDlet-Permissions}"/>

            <attribute name="J2MEUnitTestClasses"
                value="${pack}.updater.UpdaterTest,${pack}.util.StringUtilTest,${pack}.util.ThreadPoolTest,${pack}.storage.ObjectStoreTest,${pack}.storage.NamedObjectStoreTest,${pack}.storage.NamedObjectStorePerfTest,${pack}.util.MD5Test,${pack}.util.MailDateFormatterTest,${pack}.util.StringUtilTest,${pack}.util.RMS_LogDisabledTest,${pack}.util.RMSAppenderTest,${pack}.util.XmlUtilTest,${pack}.util.HttpTransportAgent,${pack}.common.pim.vcard.VCardParserTest,${pack}.util.ConnectionManagerTest,${pack}.util.WapGatewayTest,${pack}.util.BlackberryConfigurationTest"/>
            <midlet name="CommonTest" class="com.funambol.util.FunTestRunner"/>

        </wtkjad>
        
        <!-- Package everything. Most of the necessary information is
         contained in the JAD file. Also preverify the result this
         time. To obfuscate everything, set the corresponding
         parameter to "true" (requires RetroGuard or ProGuard). The
         version parameter increments the MIDlet-Version by one. -->
        
        <wtkpackage jarfile="${dir.output}/CommonTest.jar"
            jadfile="${dir.output}/CommonTest.jad"
            obfuscate="false"
            preverify="true" classpath="${wma.jar};${libs.extra}">
            
            
            <!-- Package our newly compiled classes. -->
            <fileset dir="${dir.classes}" includes="**/*.class"/>
            <!--<fileset file="${lib.junit}"/>-->
            
            <fileset dir="${dir.classes}" includes="res/*.properties" />
            <fileset dir="${basedir}/test" includes="res/*.txt" />
            
        </wtkpackage>
        
    </target>
    
    
    <!-- =============================================== -->
    <!-- DOCS                                            -->
    <!-- =============================================== -->
    <target name="docs_single" depends="init">
        
        <!--
        First of all copy all the files we want to document in a
        temporary directory, than apply javadoc
        -->
        
        <delete dir="${dir.docs}/javadoc/src"/>
        <mkdir dir="${dir.docs}/javadoc/src"/>
        
        <copy todir="${dir.docs}/javadoc/src">
            <fileset dir="${dir.src}/">
                
                <!--
                package com.funambol.storage
                package com.funambol.util
                package com.funambol.tools
                -->
                <include name="com/funambol/storage/package.html"/>
                <include name="com/funambol/util/package.html"/>
                <include name="com/funambol/tools/package.html"/>
                <include name="**/*.java"/>
            </fileset>
        </copy>
        
        <copy todir="${dir.docs}/javadoc/src">
            <fileset dir="${dir.pdsrc}/">
                
                <!--
                package com.funambol.storage
                package com.funambol.util
                package com.funambol.tools
                -->
                <include name="com/funambol/storage/package.html"/>
                <include name="com/funambol/util/package.html"/>
                <include name="com/funambol/tools/package.html"/>
                <include name="**/*.java"/>
            </fileset>
        </copy>
        
        <javadoc destdir  = "${dir.docs}/javadoc" packagenames="com.*"
             version      = "false"
             author       = "false"
             windowtitle  = "Funambol Common J2ME API ${j2me.version}">
            
            <classpath>
                <pathelement location="${wtk.midp_api}"/>
                <pathelement location="${dir.output}/${j2me.name}.jar"/>
                <pathelement location="${lib.gzip}"/>
                
            </classpath>
            
            <packageset  dir="${dir.docs}/javadoc/src" defaultexcludes="yes">
                <include name="com/funambol/storage"/>
                <include name="com/funambol/util"/>
                <include name="com/funambol/tools"/>
            </packageset>
            
            <doctitle>
                <![CDATA[<!--img src="logo.gif"--> <h1>Funambol J2ME Common API ${j2me.version}</h1>]]>
            </doctitle>
            <bottom><![CDATA[<i>Copyright &#169; 2006 Funambol.</i>]]></bottom>
        </javadoc>
        <delete dir="${dir.docs}/javadoc/pdsrc"/>
    </target>
    
    <!-- =============================================== -->
    <!-- RUN                                             -->
    <!-- =============================================== -->
    <target name="runj2me" depends="init">
        <!-- Start the MIDlet suite -->
        <wtkrun jadfile="${dir.output}/CommonTest.jad"
            device="DefaultColorPhone" wait="true">
        </wtkrun>
    </target>
    
    <!-- =============================================== -->
    <!-- DEBUG                                           -->
    <!-- =============================================== -->
    <target name="debugj2me" depends="init">
        <wtkrun jadfile="${dir.output}/CommonTest.jad"
            device="DefaultColorPhone" wait="true" debug="5000">
        </wtkrun>
    </target>
    

</project>

